REQUIRE NUMBER? ~mak/lib/fpcnum.f
REQUIRE [IF] ~mak/CompIF3.f

: [DLL_CREATE] R> DUP @ @ SWAP CELL+ COUNT EVALUATE ;

: WINAPI ( dll <wname> -- xt )
 PARSE-NAME FILE-BUFF ASCII-Z DLL_S ;

: DLL_CREATE ( dll <fmame> <wname> -- )
 >IN @ OVER @  CREATE WINAPI
 DUP 0= ABORT" api unavailable" ,
    >IN !
	HERE SWAP \ dll here
   ['] [DLL_CREATE] COMPILE,  
   ( dll ) ,  
 S" WINAPI " HERE $!
  PARSE-NAME 
  PARSE-NAME  HERE $+!
 S"  TO " HERE $+!
    HERE $+!

  HERE C@ 1+ ALLOT
  ATCOLD
   
\	CR H. PARSE-NAME TYPE PARSE-NAME TYPE
   
;

\ parameters in reverse order
(
: XAPI_0: DLL_CREATE DOES> @ XAPI_0 ;
: XAPI_1: DLL_CREATE DOES> @ XAPI_1 NIP ;
: XAPI_2: DLL_CREATE DOES> @ XAPI_2 NIP NIP ;
: XAPI_3: DLL_CREATE DOES> @ XAPI_3 NIP NIP NIP ;
: XAPI_4: DLL_CREATE DOES> @ XAPI_4 NIP NIP NIP NIP ;
: XAPI_5: DLL_CREATE DOES> @ XAPI_5 NIP NIP NIP NIP NIP ;
: XAPI_9: DLL_CREATE DOES> @ XAPI_9 NIP NIP NIP NIP NIP  NIP NIP NIP NIP ;

: XAPI0: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_0:  ;
: XAPI1: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_1:  ;
: XAPI2: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_2:  ;
: XAPI3: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_3:  ;
: XAPI4: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_4:  ;
: XAPI5: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_5:  ;
\ : XAPI6: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_6:  ;
\ : XAPI12: >IN @  POSTPONE [DEFINED]  IF DROP POSTPONE \ BREAK >IN ! XAPI_12:  ;
)
\ parameters sequence is correspond to documentation

: WAPI_0: DLL_CREATE DOES> @ NXCALL0 ;
: WAPI_1: DLL_CREATE DOES> @ NXCALL1 ;
: WAPI_2: DLL_CREATE DOES> @ NXCALL2 ;
: WAPI_3: DLL_CREATE DOES> @ NXCALL3 ;
: WAPI_4: DLL_CREATE DOES> @ NXCALL4 ;
: WAPI_5: DLL_CREATE DOES> @ 5 NXCALL ;
: WAPI_6: DLL_CREATE DOES> @ 6 NXCALL ;
: WAPI_7: DLL_CREATE DOES> @ 7 NXCALL ;
: WAPI_10: DLL_CREATE DOES> @ $A NXCALL ;
: WAPI_12: DLL_CREATE DOES> @ $C NXCALL ;


: WAPI0: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_0:  ;
: WAPI1: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_1:  ;
: WAPI2: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_2:  ;
: WAPI3: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_3:  ;
: WAPI4: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_4:  ;
: WAPI5: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_5:  ;
: WAPI6: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_6:  ;
: WAPI7: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_7:  ;
: WAPI10: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_10:  ;
: WAPI12: >IN @  POSTPONE [DEFINED]  IF 2DROP POSTPONE \ BREAK >IN ! WAPI_12:  ;

: [DLL_LOAD] R> COUNT ( CR 2DUP TYPE) EVALUATE ;

: DLL_LOAD>
 PARSE-NAME FILE-BUFF ASCII-Z DLL_L \  CR ." DLL_LOAD=" CR SOURCE TYPE CR DUP H.
DUP 0= IF ." DLL LOAD ERROR" ABORT THEN
 ;

: DLL_LOAD:
 HERE
 >IN @
 ['] [DLL_LOAD] COMPILE,
 S" DLL_LOAD> " HERE $!
 PARSE-NAME HERE $+! BL HERE $C+!
  >IN @ PARSE-NAME HERE $+! >IN !
 S"  !" HERE $+!
  HERE C@ 1+ ALLOT
  VARIABLE
 >IN !
  DLL_LOAD> LAST @ NAME> EXECUTE ! \  ,
  PARSE-NAME 2DROP
 ATCOLD
 ;

  DLL_LOAD: KERNEL32.DLL KERNEL32DLL

: WNDPROC: ( xt "name" -- )
 PARSE-NAME SHEADER

 $53 C,		\ push ebx
 $56 C,		\ push esi
 $57 C,		\ push edi
 $41 C, $55  C,	\ push r13
 $41 C, $56  C,	\ push r14
 $55 C,		\ push ebp

 $48 C, $81 C, $EC C,  $3000 L, \    subq    $0x3000,%rsp  

 POSTPONE CALLBACKIN
 POSTPONE PARAM

 COMPILE,

  $48 C, $81 C, $C4 C,  $3000 L, \ addq    $0x3000,%rsp  

    $5D C,     \ pop  ebp 
    $41 C, $5E C, \ pop r14
    $41 C, $5D C, \ pop r13   
    $5F C,     \ pop  edi 
    $5E C,     \ pop  esi 
    $5B C,    \ pop  ebx 
 POSTPONE EXIT
;
